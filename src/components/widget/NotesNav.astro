---
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	lang?: string;
	scope?: string;
}
const className = Astro.props.class;
const scope = Astro.props.scope ?? "posts";
---


<WidgetLayout id="notes-nav" name="随笔导航" class={className} isCollapsed={false}>
  <div id="notes-nav-list" class="flex flex-col gap-1"></div>
</WidgetLayout>

<script>
  function buildList() {
    const list = document.getElementById('notes-nav-list');
    if (!list) return;
    const items = Array.from(document.querySelectorAll('[id^="note-"]'));
    const links = items.map((wrap) => {
      const titleLink = wrap.querySelector('a');
      const id = wrap.id;
      const text = titleLink?.textContent?.trim() || id.replace('note-','');
      return { id, text };
    });
    list.innerHTML = links.map((it) => (
      `<a href="#${it.id}" class="btn-plain text-left px-2 h-8">${it.text}</a>`
    )).join('');
  }

  function updateNotesNavDisplay() {
  const nav = document.querySelector('[data-id="notes-nav"]');
    const list = document.getElementById('notes-nav-list');
    const pageState = document.getElementById('page-state');
    const scope = pageState?.getAttribute('data-scope');
    console.log('[NotesNav] updateNotesNavDisplay called', { nav, list, pageState, scope });
    if (!nav || !list) {
      console.warn('[NotesNav] nav or list not found');
      return;
    }
    if (scope === 'notes') {
      console.log('[NotesNav] Showing notes nav');
      nav.style.display = 'block'; // 只切换组件本身
      buildList();
    } else {
      console.log('[NotesNav] Hiding notes nav');
      nav.style.display = 'none';
      list.innerHTML = '';
    }
  }

  document.addEventListener('DOMContentLoaded', updateNotesNavDisplay);
  window.addEventListener('sidebar:update', updateNotesNavDisplay);
  if (window?.swup?.hooks) {
    window.swup.hooks.on('content:replace', updateNotesNavDisplay);
    window.swup.hooks.on('page:view', updateNotesNavDisplay);
  } else {
    document.addEventListener('swup:enable', () => {
      if (window?.swup?.hooks) {
        window.swup.hooks.on('content:replace', updateNotesNavDisplay);
        window.swup.hooks.on('page:view', updateNotesNavDisplay);
      }
    });
  }
</script>

