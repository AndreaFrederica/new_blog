---
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";

interface Props {
	username?: string;
	class?: string;
	useImageFallback?: boolean; // æ–°å¢ï¼šæ˜¯å¦ç›´æ¥ä½¿ç”¨å›¾ç‰‡æ–¹æ¡ˆ
	lang?: string; // æ–°å¢ï¼šè¯­è¨€å‚æ•°
}

const {
	username = "AndreaFrederica",
	class: className,
	useImageFallback = false,
	lang = "zh_cn",
} = Astro.props;
---

<div
  class:list={["github-stats-container card-base p-6 rounded-xl", className]}
  data-username={username}
  data-use-image-fallback={useImageFallback}
  data-lang={lang}
>
  <!-- GitHub Activity Calendar -->
  <div class="mb-8">
    <h3 class="text-xl font-bold mb-4 text-90">
      {i18n(I18nKey.githubContributionCalendar, lang)}
    </h3>
    <div class="card-base p-4">
      <div
        id="github-calendar"
        data-region="calendar"
        data-loading="true"
        class="w-full overflow-x-auto"
      >
        <div class="animate-pulse">{i18n(I18nKey.githubLoading, lang)}</div>
      </div>
    </div>
  </div>

  <!-- Interactive Stats -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Profile Stats -->
    <div class="card-base p-6">
      <h3 class="text-lg font-bold mb-4 text-90">
        {i18n(I18nKey.githubStatsInfo, lang)}
      </h3>
      <div
        id="profile-stats"
        data-region="profile-stats"
        data-loading="true"
        class="space-y-3"
      >
        <div class="animate-pulse">{i18n(I18nKey.githubLoading, lang)}</div>
      </div>
    </div>

    <!-- Language Stats -->
    <div class="card-base p-6">
      <h3 class="text-lg font-bold mb-4 text-90">
        {i18n(I18nKey.githubLanguageDistribution, lang)}
      </h3>
      <div
        id="language-chart"
        data-region="language-chart"
        data-loading="true"
        class="h-64"
      >
        <div class="animate-pulse">{i18n(I18nKey.githubLoading, lang)}</div>
      </div>
    </div>
  </div>

  <!-- Repository List -->
  <div class="card-base p-6">
    <h3 class="text-lg font-bold mb-4 text-90">
      {i18n(I18nKey.githubPopularRepos, lang)}
    </h3>
    <div
      id="repo-list"
      data-region="repo-list"
      data-loading="true"
      class="space-y-3"
    >
      <div class="animate-pulse">{i18n(I18nKey.githubLoading, lang)}</div>
    </div>
  </div>
</div>

<style>
  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(var(--black), 0.1);
  }
  /* ç»Ÿä¸€å›¾ç‰‡/å›¾è¡¨çš„æµ…è‰²èƒŒæ™¯å’Œæ–‡æœ¬é¢œè‰² */
  .image-frame {
    background: rgba(var(--black), 0.03);
    color: rgba(var(--black), 0.8);
    border: 1px solid rgba(var(--black), 0.06);
    border-radius: 12px;
    padding: 12px;
  }
  .image-frame img {
    display: block;
    max-width: 100%;
    height: auto;
  }
  
  /* GitHubæ—¥å†å®¹å™¨ç‰¹æ®Šæ ·å¼ - ç¡®ä¿èƒŒæ™¯æ›´æ˜æ˜¾ */
  #github-calendar.image-frame {
    background: rgba(var(--black), 0.05) !important;
    border: 1px solid rgba(var(--black), 0.1) !important;
    min-height: 200px;
  }
  .github-calendar{
    background: rgba(var(--black), 0.05) !important;
    border: 1px solid rgba(var(--black), 0.1) !important;
    min-height: 200px;
  }
  
  @media (prefers-color-scheme: dark) {
    .image-frame {
      background: rgba(var(--white), 0.03);
      border-color: rgba(var(--white), 0.08);
      color: rgba(var(--white), 0.9);
    }
    
    #github-calendar.image-frame {
      background: rgba(var(--white), 0.05) !important;
      border-color: rgba(var(--white), 0.1) !important;
    }
  }

  @media (prefers-color-scheme: dark) {
    .stat-item {
      border-bottom: 1px solid rgba(var(--white), 0.15);
    }
  }

  .stat-item:last-child {
    border-bottom: none;
  }

  .repo-item:hover h4 {
    color: var(--primary);
  }

  /* GitHub Calendar æ ·å¼è¦†ç›–ï¼Œç»Ÿä¸€æ–‡æœ¬é¢œè‰² - ä½¿ç”¨æ›´å¼ºåˆ¶çš„é€‰æ‹©å™¨ */
  .github-stats-container :global(#github-calendar *) {
    color: var(--black) !important;
  }
  
  .github-stats-container :global(#github-calendar text),
  .github-stats-container :global(#github-calendar svg text) {
    fill: var(--black) !important;
    color: var(--black) !important;
  }
  
  .github-stats-container :global(.js-calendar-graph text),
  .github-stats-container :global(.ContributionCalendar-label),
  .github-stats-container :global(.ContributionCalendar-label span) {
    fill: var(--black) !important;
    color: var(--black) !important;
  }
  
  /* GitHub Calendar æ‰€æœ‰æ–‡æœ¬å…ƒç´ ç»Ÿä¸€é¢œè‰² */
  .github-stats-container :global(.sr-only),
  .github-stats-container :global(.color-fg-muted),
  .github-stats-container :global(.color-fg-muted *),
  .github-stats-container :global(span[aria-hidden="true"]),
  .github-stats-container :global(span[data-view-component="true"]),
  .github-stats-container :global(.Link--muted) {
    color: var(--black) !important;
  }
  
  /* æœˆä»½æ ‡ç­¾å’Œå‘¨å‡ æ ‡ç­¾ */
  .github-stats-container :global(.ContributionCalendar-label span[aria-hidden="true"]),
  .github-stats-container :global(.ContributionCalendar-label span[style*="bottom: -4px"]) {
    color: var(--black) !important;
  }
  
  @media (prefers-color-scheme: dark) {
    .github-stats-container :global(#github-calendar *) {
      color: var(--white) !important;
    }
    
    .github-stats-container :global(#github-calendar text),
    .github-stats-container :global(#github-calendar svg text) {
      fill: var(--white) !important;
      color: var(--white) !important;
    }
    
    .github-stats-container :global(.js-calendar-graph text),
    .github-stats-container :global(.ContributionCalendar-label),
    .github-stats-container :global(.ContributionCalendar-label span) {
      fill: var(--white) !important;
      color: var(--white) !important;
    }
    
    .github-stats-container :global(.sr-only),
    .github-stats-container :global(.color-fg-muted),
    .github-stats-container :global(.color-fg-muted *),
    .github-stats-container :global(span[aria-hidden="true"]),
    .github-stats-container :global(span[data-view-component="true"]),
    .github-stats-container :global(.Link--muted) {
      color: var(--white) !important;
    }
    
    .github-stats-container :global(.ContributionCalendar-label span[aria-hidden="true"]),
    .github-stats-container :global(.ContributionCalendar-label span[style*="bottom: -4px"]) {
      color: var(--white) !important;
    }
  }

  .github-stats-container
    :global(.js-calendar-graph .ContributionCalendar-day[data-level="0"]) {
    fill: rgba(var(--black), 0.1) !important;
  }

  /* GitHub Calendar è´¡çŒ®çº§åˆ«é¢œè‰² */
  .github-stats-container
    :global(.js-calendar-graph .ContributionCalendar-day[data-level="1"]) {
    fill: oklch(0.85 0.05 var(--hue)) !important;
  }

  .github-stats-container
    :global(.js-calendar-graph .ContributionCalendar-day[data-level="2"]) {
    fill: oklch(0.75 0.08 var(--hue)) !important;
  }

  .github-stats-container
    :global(.js-calendar-graph .ContributionCalendar-day[data-level="3"]) {
    fill: oklch(0.65 0.12 var(--hue)) !important;
  }

  .github-stats-container
    :global(.js-calendar-graph .ContributionCalendar-day[data-level="4"]) {
    fill: var(--primary) !important;
  }

  @media (prefers-color-scheme: dark) {
    .github-stats-container
      :global(.js-calendar-graph .ContributionCalendar-day[data-level="0"]) {
      fill: rgba(var(--white), 0.1) !important;
    }
    
    .github-stats-container
      :global(.js-calendar-graph .ContributionCalendar-day[data-level="1"]) {
      fill: oklch(0.4 0.05 var(--hue)) !important;
    }

    .github-stats-container
      :global(.js-calendar-graph .ContributionCalendar-day[data-level="2"]) {
      fill: oklch(0.5 0.08 var(--hue)) !important;
    }

    .github-stats-container
      :global(.js-calendar-graph .ContributionCalendar-day[data-level="3"]) {
      fill: oklch(0.6 0.12 var(--hue)) !important;
    }

    .github-stats-container
      :global(.js-calendar-graph .ContributionCalendar-day[data-level="4"]) {
      fill: var(--primary) !important;
    }
  }
</style>

<script>
  import type { Repository, LanguageStats, GitHubUser } from "../types/github";

  // å…¨å±€æ¸…ç†å™¨ï¼Œç”¨äºé˜²æ­¢é‡å¤ç›‘å¬
  let globalCleanup: (() => void) | null = null;
  let activeWatchers: Set<string> = new Set();

  // æ¸…ç†å‡½æ•°
  function cleanup() {
    console.log("GitHubStats: Cleaning up previous watchers and listeners");
    if (globalCleanup) {
      globalCleanup();
      globalCleanup = null;
    }
    activeWatchers.clear();
  }

  // ç»„ä»¶æ ¹å®¹å™¨ï¼šé€‰å–æœ€æ–°ã€å·²æŒ‚è½½å¹¶å°½é‡ä¸å½“å‰è¯­è¨€åŒ¹é…çš„å®¹å™¨
  function getRoot(): HTMLElement | null {
    const all = Array.from(
      document.querySelectorAll(".github-stats-container")
    ) as HTMLElement[];
    if (!all.length) return null;
    const connected = all.filter((n) => n.isConnected);
    if (!connected.length) return all[all.length - 1] as HTMLElement; // å…œåº•
    // ä¼˜å…ˆåŒ¹é…å½“å‰è¯­è¨€
    const pathLang = (() => {
      const path = window.location.pathname;
      const m = path.match(/^\/([a-z]{2}(?:_[a-z]{2})?)(?:\/|$)/i);
      return m ? m[1].toLowerCase() : null;
    })();
    if (pathLang) {
      const matchLang = connected.find(
        (n) => n.getAttribute("data-lang")?.toLowerCase() === pathLang
      );
      if (matchLang) return matchLang;
    }
    // å–æœ€åä¸€ä¸ªï¼ˆæœ€æ–°æ¸²æŸ“çš„ï¼‰
    return connected[connected.length - 1] as HTMLElement;
  }

  // åœ¨ç»„ä»¶å†…æŒ‰ id æŸ¥è¯¢ï¼ˆå¯æŒ‡å®šæ ¹å®¹å™¨ï¼Œé¿å…æ‹¿åˆ°æ—§èŠ‚ç‚¹ï¼‰
  function qid(id: string, root?: HTMLElement | null): HTMLElement | null {
    const r = root ?? getRoot();
    return r ? r.querySelector(`#${id}`) : null;
  }

  // åœ¨ç»„ä»¶å†…æŒ‰ data-region æŸ¥è¯¢ï¼ˆå¯æŒ‡å®šæ ¹å®¹å™¨ï¼‰
  function qregion(
    name: string,
    root?: HTMLElement | null
  ): HTMLElement | null {
    const r = root ?? getRoot();
    return r ? r.querySelector(`[data-region="${name}"]`) : null;
  }

  // ä»ç»„ä»¶çš„ data å±æ€§è·å–é…ç½®
  function getUsername(): string {
    const container = document.querySelector(".github-stats-container");
    return container?.getAttribute("data-username") || "AndreaFrederica";
  }

  function shouldUseImageFallback(): boolean {
    const container = document.querySelector(".github-stats-container");
    return container?.getAttribute("data-use-image-fallback") === "true";
  }

  function getCurrentLang(): string {
    // é¦–å…ˆå°è¯•ä»ç»„ä»¶çš„ data-lang å±æ€§è·å–
    const container = document.querySelector(".github-stats-container");
    const dataLang = container?.getAttribute("data-lang");
    if (dataLang) return dataLang;

    // ç„¶åå°è¯•ä» URL è·¯å¾„æå–
    const path = window.location.pathname;
    const match = path.match(/^\/([a-z]{2}(?:_[a-z]{2})?)(?:\/|$)/i);
    if (match) {
      const lang = match[1].toLowerCase();
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¯æŒçš„è¯­è¨€
      const supportedLangs = ["zh_cn", "en", "ja", "ru"];
      if (supportedLangs.includes(lang)) {
        return lang;
      }
    }

    // é»˜è®¤è¿”å›ä¸­æ–‡
    return "zh_cn";
  }

  // i18n æ”¯æŒ
  const translations: Record<string, Record<string, string>> = {
    zh_cn: {
      publicRepos: "å…¬å¼€ä»“åº“",
      followers: "å…³æ³¨è€…",
      following: "æ­£åœ¨å…³æ³¨",
      joinedAt: "åŠ å…¥æ—¶é—´",
      loadingStats: "æ­£åœ¨åŠ è½½ç»Ÿè®¡ä¿¡æ¯...",
      loadingLanguages: "æ­£åœ¨åŠ è½½è¯­è¨€åˆ†å¸ƒ...",
      loadingRepos: "æ­£åœ¨åŠ è½½ä»“åº“åˆ—è¡¨...",
      loadingCalendar: "æ­£åœ¨åŠ è½½ GitHub è´¡çŒ®æ—¥å†...",
      loadFailed: "åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
      retry: "é‡è¯•",
      apiLimited: "GitHub API è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•",
      usingImageMode: "API å—é™ï¼Œä½¿ç”¨å›¾ç‰‡æ¨¡å¼",
      usingImageVersion: "ä½¿ç”¨å›¾ç‰‡ç‰ˆæœ¬",
      viewFullRepos: "æŸ¥çœ‹å®Œæ•´ä»“åº“åˆ—è¡¨",
      visitGithub: "è®¿é—® GitHub",
      noDescription: "æš‚æ— æè¿°",
      updatedAt: "æ›´æ–°äº",
      statsLoadFailed: "ç»Ÿè®¡å›¾ç‰‡åŠ è½½å¤±è´¥",
      languageLoadFailed: "è¯­è¨€ç»Ÿè®¡å›¾ç‰‡åŠ è½½å¤±è´¥",
      calendarLoadFailed: "è´¡çŒ®å›¾è¡¨åŠ è½½å¤±è´¥",
    },
    en: {
      publicRepos: "Public Repos",
      followers: "Followers",
      following: "Following",
      joinedAt: "Joined",
      loadingStats: "Loading statistics...",
      loadingLanguages: "Loading language distribution...",
      loadingRepos: "Loading repository list...",
      loadingCalendar: "Loading GitHub contribution calendar...",
      loadFailed: "Load failed, please try again later",
      retry: "Retry",
      apiLimited: "GitHub API rate limit exceeded, please try again later",
      usingImageMode: "API limited, using image mode",
      usingImageVersion: "Using image version",
      viewFullRepos: "View full repository list",
      visitGithub: "Visit GitHub",
      noDescription: "No description",
      updatedAt: "Updated",
      statsLoadFailed: "Stats image failed to load",
      languageLoadFailed: "Language stats image failed to load",
      calendarLoadFailed: "Contribution chart failed to load",
    },
    ja: {
      publicRepos: "ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒª",
      followers: "ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼",
      following: "ãƒ•ã‚©ãƒ­ãƒ¼ä¸­",
      joinedAt: "å‚åŠ æ—¥",
      loadingStats: "çµ±è¨ˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...",
      loadingLanguages: "è¨€èªåˆ†å¸ƒã‚’èª­ã¿è¾¼ã¿ä¸­...",
      loadingRepos: "ãƒªãƒã‚¸ãƒˆãƒªãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...",
      loadingCalendar: "GitHubã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...",
      loadFailed: "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„",
      retry: "å†è©¦è¡Œ",
      apiLimited:
        "GitHub APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„",
      usingImageMode: "APIåˆ¶é™ä¸­ã€ç”»åƒãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨",
      usingImageVersion: "ç”»åƒç‰ˆã‚’ä½¿ç”¨",
      viewFullRepos: "å®Œå…¨ãªãƒªãƒã‚¸ãƒˆãƒªãƒªã‚¹ãƒˆã‚’è¡¨ç¤º",
      visitGithub: "GitHubã«ã‚¢ã‚¯ã‚»ã‚¹",
      noDescription: "èª¬æ˜ãªã—",
      updatedAt: "æ›´æ–°æ—¥",
      statsLoadFailed: "çµ±è¨ˆç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—",
      languageLoadFailed: "è¨€èªçµ±è¨ˆç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—",
      calendarLoadFailed: "ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—",
    },
    ru: {
      publicRepos: "ĞŸÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸",
      followers: "ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¸",
      following: "ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸",
      joinedAt: "Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸",
      loadingStats: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸...",
      loadingLanguages: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ ÑĞ·Ñ‹ĞºĞ¾Ğ²...",
      loadingRepos: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸ĞµĞ²...",
      loadingCalendar: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ²ĞºĞ»Ğ°Ğ´Ğ¾Ğ² GitHub...",
      loadFailed: "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ",
      retry: "ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ",
      apiLimited: "ĞŸÑ€ĞµĞ²Ñ‹ÑˆĞµĞ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² GitHub API, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ",
      usingImageMode: "API Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹",
      usingImageVersion: "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ",
      viewFullRepos: "ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸ĞµĞ²",
      visitGithub: "ĞŸĞ¾ÑĞµÑ‚Ğ¸Ñ‚ÑŒ GitHub",
      noDescription: "Ğ‘ĞµĞ· Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ",
      updatedAt: "ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾",
      statsLoadFailed: "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸",
      languageLoadFailed: "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ ÑĞ·Ñ‹ĞºĞ¾Ğ²",
      calendarLoadFailed: "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñƒ Ğ²ĞºĞ»Ğ°Ğ´Ğ¾Ğ²",
    },
  };

  function t(key: string): string {
    const lang = getCurrentLang();
    return translations[lang]?.[key] || translations["zh_cn"][key] || key;
  }

  // Cookie ç®¡ç†åŠŸèƒ½
  function setCookie(name: string, value: string, minutes: number = 60) {
    const date = new Date();
    date.setTime(date.getTime() + minutes * 60 * 1000);
    const expires = "expires=" + date.toUTCString();
    document.cookie = `${name}=${value};${expires};path=/`;
  }

  function getCookie(name: string): string | null {
    const nameEQ = name + "=";
    const ca = document.cookie.split(";");
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === " ") c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }

  function shouldUseFallbackFromCookie(): boolean {
    const fallbackMode = getCookie("github-stats-fallback-mode");
    return fallbackMode === "true";
  }

  function setFallbackModeCookie() {
    // è®¾ç½®1å°æ—¶çš„é™çº§æ¨¡å¼
    setCookie("github-stats-fallback-mode", "true", 60);
    console.log("Set fallback mode for 1 hour");
  }

  // æ¸…é™¤é™çº§æ¨¡å¼ cookieï¼ˆæˆåŠŸåŠ è½½ API æ—¶è°ƒç”¨ï¼‰
  function clearFallbackModeCookie() {
    setCookie("github-stats-fallback-mode", "false", -1); // ç«‹å³è¿‡æœŸ
    console.log("Cleared fallback mode cookie");
  }

  // GitHub API å°è£…
  class GitHubAPI {
    private baseUrl = "https://api.github.com";
    private username: string;

    constructor(username: string) {
      this.username = username;
    }

    async fetchUser(): Promise<GitHubUser> {
      try {
        const response = await fetch(`${this.baseUrl}/users/${this.username}`, {
          headers: {
            Accept: "application/vnd.github.v3+json",
            "User-Agent": "GitHubStats-Component",
          },
        });

        if (!response.ok) {
          throw new Error(
            `GitHub API Error: ${response.status} ${response.statusText}`
          );
        }

        const data = await response.json();
        console.log("GitHub user data loaded successfully:", data.login);
        return data;
      } catch (error) {
        console.error("Failed to fetch user data:", error);
        throw error;
      }
    }

    async fetchRepos(): Promise<Repository[]> {
      try {
        const response = await fetch(
          `${this.baseUrl}/users/${this.username}/repos?sort=stars&per_page=6`,
          {
            headers: {
              Accept: "application/vnd.github.v3+json",
              "User-Agent": "GitHubStats-Component",
            },
          }
        );

        if (!response.ok) {
          throw new Error(
            `GitHub API Error: ${response.status} ${response.statusText}`
          );
        }

        const data = await response.json();
        console.log(`Loaded ${data.length} repositories`);
        return data;
      } catch (error) {
        console.error("Failed to fetch repositories:", error);
        throw error;
      }
    }

    async fetchLanguages(repos: Repository[]): Promise<LanguageStats> {
      const languageStats: LanguageStats = {};

      // åªè¯·æ±‚å‰3ä¸ªä»“åº“çš„è¯­è¨€ç»Ÿè®¡ï¼Œè¿›ä¸€æ­¥èŠ‚çœ API ä½¿ç”¨æ¬¡æ•°
      for (const repo of repos.slice(0, 3)) {
        try {
          const response = await fetch(
            `${this.baseUrl}/repos/${this.username}/${repo.name}/languages`,
            {
              headers: {
                Accept: "application/vnd.github.v3+json",
                "User-Agent": "GitHubStats-Component",
              },
            }
          );

          if (!response.ok) {
            console.warn(
              `Failed to fetch languages for ${repo.name}: ${response.status}`
            );
            continue;
          }

          const languages = await response.json();

          for (const [lang, bytes] of Object.entries(languages)) {
            languageStats[lang] =
              (languageStats[lang] || 0) + (bytes as number);
          }

          // æ·»åŠ å»¶è¿Ÿä»¥é¿å…è§¦å‘é€Ÿç‡é™åˆ¶
          await new Promise((resolve) => setTimeout(resolve, 100));
        } catch (error) {
          console.warn(`Failed to fetch languages for ${repo.name}:`, error);
        }
      }

      return languageStats;
    }
  }

  // ä¸»è¦åŠŸèƒ½
  async function initGitHubStats() {
    console.log("initGitHubStats: Starting...");

    const username = getUsername();
    console.log("initGitHubStats: Username:", username);

    const useImageFallback = shouldUseImageFallback();
    console.log("initGitHubStats: useImageFallback:", useImageFallback);

    // æ£€æŸ¥ cookie ä¸­çš„é™çº§çŠ¶æ€ï¼Œå¦‚æœåœ¨é™çº§æœŸå†…ç›´æ¥ä½¿ç”¨å›¾ç‰‡
    if (shouldUseFallbackFromCookie()) {
      console.log("Using image fallback mode from cookie (within 1 hour)");
      startFallbackWatchers(username);
      return;
    }

    // å¦‚æœé…ç½®ä¸ºç›´æ¥ä½¿ç”¨å›¾ç‰‡æ–¹æ¡ˆï¼Œè·³è¿‡ API è¯·æ±‚
    if (useImageFallback) {
      console.log("Using image fallback mode directly");
      startFallbackWatchers(username);
      return;
    }

    console.log("initGitHubStats: Creating GitHubAPI instance...");
    const api = new GitHubAPI(username);

    console.log(`Initializing GitHub stats for user: ${username}`);

    try {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showLoadingState();

      // ä¸²è¡Œè·å–æ•°æ®ä»¥èŠ‚çœ API ä½¿ç”¨æ¬¡æ•°
      console.log("Fetching user data...");
      const user = await api.fetchUser();

      console.log("User data loaded, rendering profile stats...");
      renderProfileStats(user);

      console.log("Fetching repositories...");
      const repos = await api.fetchRepos();

      console.log("Repositories loaded, rendering repo list...");
      renderRepositories(repos);

      // è·å–å¹¶æ¸²æŸ“è¯­è¨€ç»Ÿè®¡ï¼ˆå•ç‹¬å¤„ç†ï¼Œå¤±è´¥ä¸å½±å“å…¶ä»–ç»„ä»¶ï¼‰
      try {
        console.log("Fetching language statistics...");
        const languages = await api.fetchLanguages(repos);
        renderLanguageChart(languages);
      } catch (error) {
        console.warn("Failed to load language statistics:", error);
        showLanguageImageFallback(username);
      }

      // åŠ è½½ GitHub è´¡çŒ®æ—¥å†ï¼ˆå•ç‹¬å¤„ç†ï¼‰
      try {
        console.log("Loading GitHub calendar...");
        loadGitHubCalendar(username);
      } catch (error) {
        console.warn("Failed to load GitHub calendar:", error);
        showCalendarImageFallback(username);
      }

      console.log("GitHub stats initialization completed");

      // API æˆåŠŸï¼Œæ¸…é™¤é™çº§æ¨¡å¼ cookie
      clearFallbackModeCookie();
    } catch (error: any) {
      console.error("Failed to load GitHub stats:", error);

      // è®¾ç½®é™çº§æ¨¡å¼ cookie
      setFallbackModeCookie();

      // æ£€æŸ¥æ˜¯å¦æ˜¯é€Ÿç‡é™åˆ¶é—®é¢˜
      const errorMessage =
        error instanceof Error ? error.message : String(error);
      if (errorMessage.includes("403") || errorMessage.includes("rate limit")) {
        console.log(
          "Rate limit detected, using image fallback for all components"
        );
        startFallbackWatchers(username);
      } else {
        // ä½¿ç”¨ GitHub å®˜æ–¹å›¾ç‰‡ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
        console.log("API error detected, using image fallback");
        startFallbackWatchers(username);
      }
    }
  }

  function renderProfileStats(user: GitHubUser) {
    const container = qid("profile-stats") || qregion("profile-stats");
    if (!container) return;

    container.innerHTML = `
      <div class="stat-item">
        <span class="text-75">${t("publicRepos")}</span>
        <span class="font-bold text-90">${user.public_repos}</span>
      </div>
      <div class="stat-item">
        <span class="text-75">${t("followers")}</span>
        <span class="font-bold text-90">${user.followers}</span>
      </div>
      <div class="stat-item">
        <span class="text-75">${t("following")}</span>
        <span class="font-bold text-90">${user.following}</span>
      </div>
      <div class="stat-item">
        <span class="text-75">${t("joinedAt")}</span>
        <span class="text-50">${new Date(user.created_at).getFullYear()}</span>
      </div>
    `;
    container.setAttribute("data-loading", "false");
  }

  function renderRepositories(repos: Repository[]) {
    const container = qid("repo-list") || qregion("repo-list");
    if (!container) return;

    container.innerHTML = repos
      .map(
        (repo) => `
      <div class="repo-item cursor-pointer p-4 border border-black/10 dark:border-white/15 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition" onclick="window.open('${repo.html_url}', '_blank')">
        <div class="flex justify-between items-start mb-2">
          <h4 class="font-bold text-90 hover:text-[var(--primary)] transition">${repo.name}</h4>
          <div class="flex items-center gap-2 text-sm text-50">
            <span>â­ ${repo.stargazers_count}</span>
            <span>ğŸ´ ${repo.forks_count}</span>
          </div>
        </div>
        <p class="text-sm text-75 mb-2">${repo.description || t("noDescription")}</p>
        <div class="flex items-center gap-2 text-xs text-50">
          ${repo.language ? `<span class="px-2 py-1 bg-[var(--primary)]/20 text-90 rounded">${repo.language}</span>` : ""}
          <span>${t("updatedAt")} ${new Date(repo.updated_at).toLocaleDateString()}</span>
        </div>
      </div>
    `
      )
      .join("");
    container.setAttribute("data-loading", "false");
  }

  function renderLanguageChart(languages: LanguageStats) {
    const container = qid("language-chart") || qregion("language-chart");
    if (!container) return;

    const total = Object.values(languages).reduce(
      (sum: number, bytes: number) => sum + bytes,
      0
    );
    const sortedLanguages = Object.entries(languages)
      .sort(([, a], [, b]) => (b as number) - (a as number))
      .slice(0, 8);

    const colors = [
      "oklch(0.65 0.12 var(--hue))",
      "oklch(0.70 0.10 calc(var(--hue) + 60))",
      "oklch(0.75 0.08 calc(var(--hue) + 120))",
      "oklch(0.65 0.10 calc(var(--hue) + 180))",
      "oklch(0.70 0.08 calc(var(--hue) + 240))",
      "oklch(0.75 0.06 calc(var(--hue) + 300))",
      "oklch(0.80 0.04 var(--hue))",
      "oklch(0.60 0.08 var(--hue))",
    ];

    container.innerHTML = sortedLanguages
      .map(([lang, bytes], index) => {
        const percentage = (((bytes as number) / total) * 100).toFixed(1);
        return `
        <div class="mb-3">
          <div class="flex justify-between text-sm mb-1">
            <span class="text-90">${lang}</span>
            <span class="text-75">${percentage}%</span>
          </div>
          <div class="language-bar h-2 bg-black/10 dark:bg-white/10 rounded-full overflow-hidden">
            <div class="language-progress h-full rounded-full transition-all duration-300" 
                 style="width: ${percentage}%; background-color: ${colors[index % colors.length]}">
            </div>
          </div>
        </div>
      `;
      })
      .join("");
    container.setAttribute("data-loading", "false");
  }

  function loadGitHubCalendar(username: string) {
    const container = qid("github-calendar") || qregion("calendar");
    if (!container) return;

    // å¦‚æœå½“å‰ä¸ºé™çº§æ¨¡å¼æˆ–é…ç½®ä¸ºå›¾ç‰‡æ¨¡å¼ï¼Œç›´æ¥ä½¿ç”¨å›¾ç‰‡ï¼Œä¸åŠ è½½è„šæœ¬
    if (shouldUseFallbackFromCookie() || shouldUseImageFallback()) {
      console.log(
        "loadGitHubCalendar: in fallback/image mode, using image and skipping script load"
      );
      showCalendarImageFallback(username);
      return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    container.classList.add("image-frame");
    container.innerHTML = `<div class="animate-pulse text-center py-4">${t("loadingCalendar")}</div>`;

    // è®¾ç½®æ›´çŸ­çš„è¶…æ—¶æ—¶é—´ï¼Œå¿«é€Ÿé™çº§åˆ°å›¾ç‰‡
    const timeoutId = setTimeout(() => {
      console.warn("GitHub calendar loading timeout, falling back to image");
      showCalendarImageFallback(username);
    }, 1500); // ç¼©çŸ­åˆ°1.5ç§’è¶…æ—¶

    // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡è„šæœ¬
    if (window.GitHubCalendar) {
      clearTimeout(timeoutId);
      initializeCalendar();
      return;
    }

    // å°è¯•åŠ è½½ç¬¬ä¸‰æ–¹åº“
    const script = document.createElement("script");
    script.src = "https://unpkg.com/github-calendar@latest/dist/github-calendar.min.js";
    
    // å¢åŠ æ›´å¿«çš„é”™è¯¯æ£€æµ‹
    script.timeout = 2000; // 2ç§’è„šæœ¬åŠ è½½è¶…æ—¶
    
    const handleError = () => {
      console.error("Failed to load GitHub calendar script, using image fallback");
      clearTimeout(timeoutId);
      showCalendarImageFallback(username);
    };

    script.onerror = handleError;
    
    // æ·»åŠ åŠ è½½è¶…æ—¶æ£€æµ‹
    const scriptTimeoutId = setTimeout(() => {
      console.warn("Script loading timeout, falling back to image");
      handleError();
    }, 1000); // ç¼©çŸ­åˆ°1ç§’

    script.onload = () => {
      clearTimeout(scriptTimeoutId);
      if (typeof window.GitHubCalendar !== "undefined") {
        clearTimeout(timeoutId);
        initializeCalendar();
      } else {
        handleError();
      }
    };

    function initializeCalendar() {
      try {
        // æ¸…ç©ºå®¹å™¨å‡†å¤‡åŠ è½½ï¼Œä½†ä¿æŒ image-frame ç±»
        if (!container) return;
        container.innerHTML = "";
        container.classList.add("image-frame");

        // @ts-ignore
        GitHubCalendar(container, username, {
          responsive: true,
          tooltips: true,
          global_stats: false,
        });

        console.log("GitHub calendar loaded successfully");

        // æ£€æŸ¥åŠ è½½ç»“æœ
        setTimeout(() => {
          if (container.children.length > 0 && container.innerHTML.trim() !== "") {
            container.classList.add("image-frame");
            applyCalendarTextStyles(container);
            console.log("GitHub calendar: background styling and text colors applied");
          } else {
            console.warn("GitHub calendar appears to be empty, using image fallback");
            showCalendarImageFallback(username);
          }
        }, 500); // ç¼©çŸ­åˆ°0.5ç§’
      } catch (error) {
        console.error("Error initializing GitHub calendar:", error);
        showCalendarImageFallback(username);
      }
    }

    document.head.appendChild(script);

    // åŠ è½½æ ·å¼ï¼ˆå¦‚æœåŠ è½½å¤±è´¥ä¹Ÿä¸å½±å“ï¼‰
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "https://unpkg.com/github-calendar@latest/dist/github-calendar-responsive.css";
    link.onerror = () => {
      console.warn("Failed to load GitHub calendar styles");
    };
    document.head.appendChild(link);
  }

  // å¼ºåˆ¶åº”ç”¨æ—¥å†æ–‡æœ¬æ ·å¼åˆ°åŠ¨æ€ç”Ÿæˆçš„å†…å®¹
  function applyCalendarTextStyles(container: HTMLElement) {
    const isDark = 
      document.documentElement.getAttribute("data-theme") === "dark" ||
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    
    const textColor = isDark ? "var(--white)" : "var(--black)";
    
    // æ ¹æ®å®é™…HTMLç»“æ„æŸ¥æ‰¾æ‰€æœ‰æ–‡æœ¬å…ƒç´ 
    const textSelectors = [
      // GitHub calendar ç”Ÿæˆçš„æ–‡æœ¬å…ƒç´ 
      'span[data-view-component="true"]', // "Less", "More" ç­‰
      '.Link--muted', // "Learn how we count contributions" é“¾æ¥
      '.color-fg-muted', // åŒ…å«å›¾ä¾‹çš„å®¹å™¨
      '.sr-only', // å±å¹•é˜…è¯»å™¨æ–‡æœ¬
      'span[aria-hidden="true"]', // éšè—çš„spanå…ƒç´ 
      // SVG ç›¸å…³
      'text',
      '.js-calendar-graph text',
      'text[text-anchor]',
      'text[dy]',
      'text[dx]',
      // å…¶ä»–å¯èƒ½çš„å…ƒç´ 
      '.ContributionCalendar-label',
      '.ContributionCalendar-label span'
    ];
    
    // åº”ç”¨æ ·å¼åˆ°æ‰€æœ‰åŒ¹é…çš„å…ƒç´ 
    textSelectors.forEach(selector => {
      const elements = container.querySelectorAll(selector);
      elements.forEach((el: any) => {
        if (el.tagName.toLowerCase() === 'text') {
          // SVG text å…ƒç´ ä½¿ç”¨ fill
          el.style.setProperty('fill', textColor, 'important');
        }
        // æ‰€æœ‰å…ƒç´ éƒ½è®¾ç½® color
        el.style.setProperty('color', textColor, 'important');
      });
    });
    
    // ç‰¹åˆ«å¤„ç† .color-fg-muted å®¹å™¨å†…çš„æ‰€æœ‰å­å…ƒç´ 
    const mutedContainers = container.querySelectorAll('.color-fg-muted');
    mutedContainers.forEach((mutedContainer: any) => {
      const allChildren = mutedContainer.querySelectorAll('*');
      allChildren.forEach((child: any) => {
        child.style.setProperty('color', textColor, 'important');
      });
    });
    
    console.log(`Applied calendar text styles with color: ${textColor} to calendar elements`);
  }

  function showError() {
    const containers = ["profile-stats", "language-chart", "repo-list"];
    containers.forEach((id) => {
      const element = qid(id) || qregion(id);
      if (element) {
        element.innerHTML = `<div class="text-75 opacity-50 text-center py-4">${t("loadFailed")}</div>`;
        addRetryButton(element);
      }
    });

    // æ˜¾ç¤ºæ—¥å†é”™è¯¯
    const calendarContainer = qid("github-calendar") || qregion("calendar");
    if (calendarContainer) {
      calendarContainer.innerHTML = `<div class="text-75 opacity-50 text-center py-4">${t("calendarLoadFailed")}</div>`;
    }
  }

  function showLoadingState() {
    const containers = [
      {
        id: "profile-stats",
        content: `<div class="animate-pulse text-center py-4">${t("loadingStats")}</div>`,
      },
      {
        id: "language-chart",
        content: `<div class="animate-pulse text-center py-4">${t("loadingLanguages")}</div>`,
      },
      {
        id: "repo-list",
        content: `<div class="animate-pulse text-center py-4">${t("loadingRepos")}</div>`,
      },
    ];

    containers.forEach(({ id, content }) => {
      const element = qid(id) || qregion(id);
      if (element) {
        element.innerHTML = content;
        element.setAttribute("data-loading", "true");
      }
    });
  }

  function showLanguageError() {
    const element = qid("language-chart") || qregion("language-chart");
    if (element) {
      element.innerHTML = `<div class="text-75 opacity-50 text-center py-4">${t("languageLoadFailed")}</div>`;
    }
  }

  function showCalendarError() {
    const calendarContainer = qid("github-calendar") || qregion("calendar");
    if (!calendarContainer) return;

    // å…ˆå°è¯•å›¾ç‰‡é™çº§
    const username = getUsername();
    if (username) {
      showCalendarImageFallback(username);
    } else {
      calendarContainer.innerHTML = `<div class="text-75 opacity-50 text-center py-4">${t("calendarLoadFailed")}</div>`;
    }
  }

  function showRateLimitError() {
    const username = getUsername();

    // ä½¿ç”¨å›¾ç‰‡é™çº§æ–¹æ¡ˆè€Œä¸æ˜¯ä»…æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    console.log("Rate limit detected, falling back to image solutions");

    // ç»Ÿè®¡ä¿¡æ¯é™çº§åˆ°å›¾ç‰‡
    const profileStats = qid("profile-stats") || qregion("profile-stats");
    if (profileStats) {
      const isDark =
        document.documentElement.getAttribute("data-theme") === "dark" ||
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      const theme = isDark ? "dark" : "default";

      profileStats.innerHTML = `
        <div class="text-center">
          <div class="text-xs text-75 opacity-75 mb-2">${t("usingImageMode")}</div>
          <img src="https://github-readme-stats.vercel.app/api?username=${username}&show_icons=true&theme=${theme}&hide_border=true&bg_color=00000000" 
               alt="GitHub Stats" 
               class="w-full max-w-md mx-auto"
               onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div class="text-75 opacity-50 py-4" style="display: none;">${t("statsLoadFailed")}</div>
        </div>
      `;
    }

    // è¯­è¨€åˆ†å¸ƒé™çº§åˆ°å›¾ç‰‡
    showLanguageImageFallback(username);

    // ä»“åº“åˆ—è¡¨æä¾› GitHub é“¾æ¥
    const repoList = qid("repo-list") || qregion("repo-list");
    if (repoList) {
      repoList.innerHTML = `
        <div class="text-center py-4">
          <div class="text-xs text-75 opacity-75 mb-2">${t("usingImageMode")}</div>
          <a href="https://github.com/${username}?tab=repositories" 
             target="_blank" 
             class="inline-block px-4 py-2 bg-primary text-white rounded hover:opacity-80 transition">
            ${t("visitGithub")}
          </a>
        </div>
      `;
    }

    // æ—¥å†ä¹Ÿé™çº§åˆ°å›¾ç‰‡æ–¹æ¡ˆ
    showCalendarImageFallback(username);
  }

  // GitHub å®˜æ–¹å›¾ç‰‡å¤‡é€‰æ–¹æ¡ˆ
  function showImageFallback(username: string, root?: HTMLElement | null) {
    console.log("showImageFallback: Starting for username:", username);

    // æ£€æµ‹å½“å‰ä¸»é¢˜
    const isDark =
      document.documentElement.getAttribute("data-theme") === "dark" ||
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const theme = isDark ? "dark" : "default";

    console.log("showImageFallback: Theme detected:", theme);

    // ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨ GitHub å®˜æ–¹ç»Ÿè®¡å›¾ç‰‡ï¼ˆå¤šæºå›é€€ï¼‰
    const profileStats =
      qid("profile-stats", root) || qregion("profile-stats", root);
    if (profileStats) {
      console.log("showImageFallback: Updating profile stats");
      const sources = [
        `https://github-readme-stats.vercel.app/api?username=${username}&show_icons=true&theme=${theme}&hide_border=true&bg_color=00000000`,
        // å¸¸ç”¨é•œåƒï¼ˆç¤¾åŒºé•œåƒï¼‰
        `https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api?username=${username}&show_icons=true&theme=${theme}&hide_border=true&bg_color=00000000`,
      ];
      renderImageWithFallback(
        profileStats,
        sources,
        "GitHub Stats",
        "w-full max-w-md mx-auto"
      );
    } else {
      console.error("showImageFallback: profile-stats element not found");
    }

    // è¯­è¨€ä¸æ—¥å†æ”¹ç”± watchers åˆ†åˆ«ç­‰å¾…å¹¶æ¸²æŸ“ï¼Œé¿å…é‡å¤æ³¨å…¥

    // ä»“åº“åˆ—è¡¨æ˜¾ç¤ºç®€å•ä¿¡æ¯
    const repoList = qid("repo-list", root) || qregion("repo-list", root);
    if (repoList) {
      console.log("showImageFallback: Updating repo list");
      repoList.innerHTML = `
        <div class="text-center py-4">
          <div class="text-75 mb-2">æŸ¥çœ‹å®Œæ•´ä»“åº“åˆ—è¡¨</div>
          <a href="https://github.com/${username}?tab=repositories" 
             target="_blank" 
             class="inline-block px-4 py-2 bg-primary text-white rounded hover:opacity-80 transition">
            è®¿é—® GitHub
          </a>
        </div>
      `;
    } else {
      console.error("showImageFallback: repo-list element not found");
    }

    // æ—¥å†äº¤ç”± watcher æ¸²æŸ“

    console.log("showImageFallback: Completed");
  }

  function showLanguageImageFallback(
    username: string,
    root?: HTMLElement | null
  ) {
    console.log("showLanguageImageFallback: Starting for username:", username);
    // æ£€æµ‹å½“å‰ä¸»é¢˜
    const isDark =
      document.documentElement.getAttribute("data-theme") === "dark" ||
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const theme = isDark ? "dark" : "default";
    const languageChart =
      qid("language-chart", root) || qregion("language-chart", root);
    if (languageChart) {
      console.log("showLanguageImageFallback: Updating language chart");
      const wrapper = document.createElement("div");
      wrapper.className = "image-frame text-center";
      const hint = document.createElement("div");
      hint.className = "text-xs text-75 opacity-75 mb-2";
      hint.textContent = t("usingImageVersion");
      const imgContainer = document.createElement("div");
      imgContainer.className = "w-full max-w-md mx-auto";
      wrapper.appendChild(hint);
      wrapper.appendChild(imgContainer);
      languageChart.innerHTML = "";
      languageChart.appendChild(wrapper);
      const sources = [
        `https://github-readme-stats.vercel.app/api/top-langs/?username=${username}&layout=compact&theme=${theme}&hide_border=true&bg_color=00000000`,
        `https://github-readme-stats-git-masterrstaa-rickstaa.vercel.app/api/top-langs/?username=${username}&layout=compact&theme=${theme}&hide_border=true&bg_color=00000000`,
      ];
      renderImageInto(
        imgContainer,
        sources,
        "Top Languages",
        "w-full max-w-md mx-auto",
        '<div class="text-75 opacity-50 py-4">è¯­è¨€ç»Ÿè®¡åŠ è½½å¤±è´¥</div>'
      );
      languageChart.setAttribute("data-loading", "false");
    } else {
      console.error(
        "showLanguageImageFallback: language-chart element not found"
      );
    }
  }

  // è´¡çŒ®æ—¥å†å›¾ç‰‡é™çº§ï¼ˆå¤šæºå›é€€ï¼‰
  function showCalendarImageFallback(
    username: string,
    root?: HTMLElement | null
  ) {
    const container = qid("github-calendar", root) || qregion("calendar", root);
    if (!container) return;
    
    console.log("showCalendarImageFallback: Starting for username:", username);
    
    const isDark =
      document.documentElement.getAttribute("data-theme") === "dark" ||
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const theme = isDark ? "github-dark" : "github";
    const ghGreen = isDark ? "39d353" : "30a14e";
    const bg = isDark ? "0d1117" : "ffffff";
    const sources = [
      // æ´»åŠ¨å›¾ï¼ˆé€æ˜èƒŒæ™¯åœ¨æŸäº›ä¸»é¢˜ä¸‹ä¼šæ˜¾ç¤ºå¼‚å¸¸ï¼Œè¿™é‡Œæä¾›ä¸é€æ˜å…œåº•ç‰ˆæœ¬ï¼‰
      `https://github-readme-activity-graph.vercel.app/graph?username=${username}&theme=${theme}&hide_border=true&bg_color=00000000`,
      `https://github-readme-activity-graph.vercel.app/graph?username=${username}&theme=${theme}&hide_border=true&bg_color=${bg}`,
      // ghchart ç®€æ´ç‰ˆ
      `https://ghchart.rshah.org/${ghGreen}/${username}`,
    ];
    
    // ç›´æ¥åˆ›å»ºå›¾ç‰‡å®¹å™¨ï¼Œä¸æ˜¾ç¤º"åŠ è½½ä¸­..."
    const wrap = document.createElement("div");
    wrap.className = "image-frame text-center";
    const imgBox = document.createElement("div");
    imgBox.className = "overflow-x-auto";
    wrap.appendChild(imgBox);
    
    // æ¸…ç©ºå®¹å™¨å¹¶ç›´æ¥æ·»åŠ å›¾ç‰‡å®¹å™¨
    container.innerHTML = "";
    container.appendChild(wrap);
    
    renderImageInto(
      imgBox,
      sources,
      "GitHub Activity",
      "max-w-full h-auto mx-auto rounded-lg shadow-sm",
      `<div class="text-red-500 text-center py-4">æ—¥å†å›¾ç‰‡åŠ è½½å¤±è´¥</div>`
    );
    container.setAttribute("data-loading", "false");
  }

  // é€šç”¨ï¼šæŠŠå›¾ç‰‡æ¸²æŸ“åˆ°æŒ‡å®šå®¹å™¨å¹¶æŒ‰é¡ºåºå›é€€
  function renderImageInto(
    target: HTMLElement,
    sources: string[],
    alt: string,
    className: string,
    errorHtml: string
  ) {
    const img = new Image();
    let idx = 0;
    img.alt = alt;
    img.className = className;
    img.loading = "lazy";
    img.decoding = "async" as any;
    img.referrerPolicy = "no-referrer";
    const tryNext = () => {
      if (idx >= sources.length) {
        console.error(
          "renderImageInto: exhausted all sources, rendering errorHtml"
        );
        target.innerHTML = errorHtml;
        return;
      }
      const src = sources[idx++];
      console.log("renderImageInto: try", src);
      img.src = src;
    };
    img.onerror = () => {
      console.warn("renderImageInto: image failed, trying next");
      tryNext();
    };
    img.onload = () => {
      console.log(
        "renderImageInto: image loaded",
        img.currentSrc || img.src,
        `${img.naturalWidth}x${img.naturalHeight}`
      );
    };
    target.innerHTML = "";
    console.log("renderImageInto: append image into target", target);
    target.appendChild(img);
    tryNext();
  }

  // è¯­æ³•ç³–ï¼šç›´æ¥å¾€å®¹å™¨èŠ‚ç‚¹æ¸²æŸ“ï¼ˆå‘åå…¼å®¹æ—§è°ƒç”¨ï¼‰
  function renderImageWithFallback(
    container: HTMLElement,
    sources: string[],
    alt: string,
    className: string
  ) {
    const inner = document.createElement("div");
    inner.className = "image-frame text-center";
    const imgBox = document.createElement("div");
    imgBox.className = "w-full max-w-md mx-auto";
    inner.appendChild(imgBox);
    container.innerHTML = "";
    console.log("renderImageWithFallback: container ready", container);
    container.appendChild(inner);
    renderImageInto(
      imgBox,
      sources,
      alt,
      className,
      '<div class="text-75 opacity-50 py-4">å›¾ç‰‡åŠ è½½å¤±è´¥</div>'
    );
    container.setAttribute("data-loading", "false");
  }

  // å•åŒºåŸŸç›‘å¬ï¼šç­‰æŸä¸ªå®¹å™¨å‡ºç°åå†æ¸²æŸ“å¯¹åº”å†…å®¹ï¼ˆç”¨äºåˆæ¬¡åŠ è½½ä¸è¯­è¨€åˆ‡æ¢åœºæ™¯ï¼‰
  function ensureRegionAndRender(
    regionId: string,
    render: (root: HTMLElement) => void,
    options?: { requireLoading?: boolean }
  ) {
    const getCurrentRoot = () => getRoot();
    const getEl = (r?: HTMLElement | null) =>
      (qid(regionId, r) || qregion(regionId, r)) as HTMLElement | null;
    const hasLoadingTag = (el: HTMLElement | null) => {
      if (!el) return false;
      // é¦–é€‰ data-loading æ ‡è®°
      const attr = el.getAttribute("data-loading");
      if (attr === "true") return true;
      // å…¼å®¹è€çš„æ–‡æœ¬æ£€æµ‹
      const text = (el.textContent || "").toLowerCase();
      return (
        text.includes("loading") ||
        text.includes("åŠ è½½") ||
        text.includes("èª­ã¿è¾¼ã¿") ||
        text.includes("Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°")
      );
    };
    const isReady = () => {
      const root = getCurrentRoot();
      const el = getEl(root);
      const baseReady = !!(el && el.isConnected && document.body.contains(el));
      if (!baseReady) return false;
      if (options?.requireLoading) {
        // åªæœ‰å½“å®¹å™¨ä»å¤„äºâ€œLoadingâ€¦â€æ–‡æœ¬æ—¶æ‰ç®—é¦–æ¬¡ readyï¼Œé¿å…å‘½ä¸­è¿‡æ—¶å†…å®¹
        return hasLoadingTag(el);
      }
      return true;
    };
    const doRender = (why: string) => {
      const root = getCurrentRoot();
      const el = getEl(root);
      console.log(
        `ensureRegionAndRender: region ready (${why})`,
        regionId,
        el,
        "root=",
        root
      );
      // ä½¿ç”¨åŒ rAF ç­‰å¾… DOM ç¨³å®šï¼Œé¿å…åˆšå¥½è¢« Astro æ›¿æ¢
      requestAnimationFrame(() =>
        requestAnimationFrame(() => {
          const root2 = getCurrentRoot();
          const el2 = getEl(root2);
          if (el2 && el2.isConnected && root2) {
            render(root2);
            // æ¸²æŸ“åå† guard ä¸€æ¬¡ï¼šè‹¥æ¸²æŸ“ååˆè¢«æ›¿æ¢å› Loadingï¼Œåˆ™é‡æ–°ç­‰å¾…
            setTimeout(() => {
              const root3 = getCurrentRoot();
              const el3 = getEl(root3);
              if (options?.requireLoading && el3 && hasLoadingTag(el3)) {
                console.warn(
                  "ensureRegionAndRender: element went back to loading, but not re-watching to prevent infinite loops",
                  regionId
                );
                // ä¸å†é‡æ–°ç›‘å¬ï¼Œé˜²æ­¢æ— é™å¾ªç¯
              }
            }, 100);
          } else {
            console.warn(
              "ensureRegionAndRender: element lost before render",
              regionId
            );
          }
        })
      );
    };
    const watch = () => {
      console.log("ensureRegionAndRender: waiting for region", regionId);
      const intervalId = window.setInterval(() => {
        if (isReady()) {
          clearInterval(intervalId);
          obs.disconnect();
          doRender("interval");
        }
      }, 120);
      const obs = new MutationObserver(() => {
        if (isReady()) {
          clearInterval(intervalId);
          obs.disconnect();
          doRender("observer");
        }
      });
      obs.observe(document.body, { childList: true, subtree: true });
    };
    if (isReady()) {
      doRender("immediate");
    } else {
      watch();
    }
  }

  function startFallbackWatchers(username: string) {
    console.log("startFallbackWatchers: waiting for regions");
    ensureRegionAndRender(
      "profile-stats",
      (root) => {
        console.log("startFallbackWatchers: rendering profile-stats");
        showImageFallback(username, root);
      },
      { requireLoading: true }
    );
    ensureRegionAndRender(
      "language-chart",
      (root) => {
        console.log("startFallbackWatchers: rendering language-chart");
        showLanguageImageFallback(username, root);
      },
      { requireLoading: true }
    );
    ensureRegionAndRender("github-calendar", (root) => {
      console.log("startFallbackWatchers: rendering github-calendar");
      showCalendarImageFallback(username, root);
    }, { requireLoading: true });
    // repo-list ç”± showImageFallback ä¸€å¹¶å¤„ç†ï¼›è‹¥éœ€è¦å•ç‹¬å¤„ç†å¯åŠ  ensureRegionAndRender('repo-list', ...)
  }

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  document.addEventListener("DOMContentLoaded", () => {
    // æ·»åŠ é‡è¯•æŒ‰é’®åŠŸèƒ½
    addRetryFunctionality();

    // æ£€æŸ¥ cookie ä¸­çš„é™çº§çŠ¶æ€å’Œé…ç½®
    const shouldUseImage = shouldUseImageFallback();
    const shouldUseFallback = shouldUseFallbackFromCookie();

    // å¦‚æœé…ç½®äº†ç›´æ¥ä½¿ç”¨å›¾ç‰‡ï¼Œæˆ–è€…åœ¨é™çº§æœŸå†…ï¼Œç›´æ¥ä½¿ç”¨å›¾ç‰‡
    if (shouldUseImage || shouldUseFallback) {
      const reason = shouldUseImage ? "config" : "cookie fallback";
      console.log(`Using image mode directly based on ${reason}`);
      const username = getUsername();
      // ç­‰å¾…å®¹å™¨å°±ç»ªåå†æ¸²æŸ“ï¼Œé¿å…åˆæ¬¡åŠ è½½æ—¶ DOM ä»åœ¨æ¸²æŸ“
      startFallbackWatchers(username);
    } else {
      // å¦åˆ™å°è¯• API æ¨¡å¼
      initGitHubStats();
    }

    // ç›‘å¬è¯­è¨€åˆ‡æ¢
    setupLanguageChangeListener();
    
    // æ·»åŠ é¡µé¢çº§åˆ«çš„æ¸…ç†ç›‘å¬å™¨
    setupPageLifecycleListeners();
  });

  // è¯­è¨€åˆ‡æ¢ç›‘å¬å™¨
  function setupLanguageChangeListener() {
    let currentLang = getCurrentLang();
    let isProcessingChange = false;

    // æ£€æŸ¥ URL å˜åŒ–çš„å‡½æ•°
    function checkLanguageChange() {
      if (isProcessingChange) return; // é˜²æ­¢é‡å¤å¤„ç†

      const container = document.querySelector(".github-stats-container");
      if (!container) return;

      // ä» URL è·¯å¾„æå–è¯­è¨€
      const pathLang = extractLanguageFromPath();

      // æ›´æ–°ç»„ä»¶çš„ data-lang å±æ€§
      if (pathLang !== container.getAttribute("data-lang")) {
        container.setAttribute("data-lang", pathLang);
      }

      const newLang = getCurrentLang();
      if (newLang !== currentLang) {
        console.log(`Language changed from ${currentLang} to ${newLang}`);
        isProcessingChange = true;
        currentLang = newLang;

        // ç«‹å³æ¸…ç©ºåŠ è½½çŠ¶æ€ï¼Œé¿å…æ˜¾ç¤ºé”™è¯¯çš„è¯­è¨€
        clearLoadingStates();

        // æ£€æŸ¥æ˜¯å¦åœ¨é™çº§æœŸå†…æˆ–é…ç½®ä½¿ç”¨å›¾ç‰‡æ¨¡å¼
        const shouldUseFallback = shouldUseFallbackFromCookie();
        const shouldUseImage = shouldUseImageFallback();

        if (shouldUseFallback || shouldUseImage) {
          const reason = shouldUseImage ? "config" : "cookie fallback";
          console.log(`Using image fallback due to ${reason}`);
          const username = getUsername();
          if (username) {
            // ç­‰å¾…æ–° DOM ç¨³å®šåå†æ¸²æŸ“ï¼Œé¿å…è¯­è¨€åˆ‡æ¢æ—¶å®¹å™¨è¢«æ›¿æ¢å¯¼è‡´æŒ‚è½½å¤±è´¥
            startFallbackWatchers(username);
          }
        } else {
          // é‡æ–°åˆå§‹åŒ– API æ¨¡å¼ï¼Œä½†ä½¿ç”¨æ›´çŸ­çš„è¶…æ—¶
          console.log("Reinitializing GitHub stats for new language");
          initGitHubStats(); // ä½¿ç”¨ç°æœ‰å‡½æ•°
        }

        // é‡ç½®å¤„ç†çŠ¶æ€
        setTimeout(() => {
          isProcessingChange = false;
        }, 500);
      }
    }

    // æ¸…ç©ºæ‰€æœ‰åŠ è½½çŠ¶æ€çš„å‡½æ•°
    function clearLoadingStates() {
      const loadingElements = [
        "#profile-stats",
        "#language-chart",
        "#repo-list",
        "#github-calendar",
      ];

      loadingElements.forEach((selector) => {
        const element = document.querySelector(selector);
        if (
          element &&
          (element.textContent?.includes("åŠ è½½ä¸­") ||
            element.textContent?.includes("Loading"))
        ) {
          element.innerHTML = `<div class="animate-pulse text-center py-4">${t("loading")}</div>`;
        }
      });
    }

    // ç¡®ä¿ä½¿ç”¨é¡¶å±‚çš„ ensureRegionAndRender/startFallbackWatchers

    // ä» URL è·¯å¾„æå–è¯­è¨€çš„å‡½æ•°
    function extractLanguageFromPath(): string {
      const path = window.location.pathname;
      const match = path.match(/^\/([a-z]{2}(?:_[a-z]{2})?)(?:\/|$)/i);
      if (match) {
        const lang = match[1].toLowerCase();
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ”¯æŒçš„è¯­è¨€
        const supportedLangs = ["zh_cn", "en", "ja", "ru"];
        if (supportedLangs.includes(lang)) {
          return lang;
        }
      }
      return "zh_cn"; // é»˜è®¤è¯­è¨€
    }

    // åˆå§‹æ£€æŸ¥
    checkLanguageChange();

    // ä½¿ç”¨ MutationObserver ç›‘å¬ data-lang å±æ€§å˜åŒ–
    const container = document.querySelector(".github-stats-container");
    if (container) {
      const observer = new MutationObserver(checkLanguageChange);
      observer.observe(container, {
        attributes: true,
        attributeFilter: ["data-lang"],
      });
    }

    // ç›‘å¬ popstate äº‹ä»¶ï¼ˆæµè§ˆå™¨å‰è¿›åé€€ï¼‰
    window.addEventListener("popstate", () => {
      setTimeout(checkLanguageChange, 100);
    });

    // ç›‘å¬ pushstate å’Œ replacestateï¼ˆSPA å¯¼èˆªï¼‰
    const originalPushState = history.pushState;
    const originalReplaceState = history.replaceState;

    history.pushState = function (...args) {
      originalPushState.apply(history, args);
      setTimeout(checkLanguageChange, 100);
    };

    history.replaceState = function (...args) {
      originalReplaceState.apply(history, args);
      setTimeout(checkLanguageChange, 100);
    };
  }

  // é¡µé¢ç”Ÿå‘½å‘¨æœŸç›‘å¬å™¨ - å¤„ç†é¡µé¢åˆ‡æ¢æ—¶çš„æ¸…ç†å’Œé‡æ–°åˆå§‹åŒ–
  function setupPageLifecycleListeners() {
    console.log("Setting up page lifecycle listeners");
    
    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆé¡µé¢åˆ‡æ¢ã€æœ€å°åŒ–ç­‰ï¼‰
    document.addEventListener("visibilitychange", () => {
      const container = document.querySelector(".github-stats-container");
      if (!container) return;
      
      if (document.hidden) {
        console.log("Page hidden, cleaning up GitHub stats watchers");
        // é¡µé¢éšè—æ—¶æ¸…ç†èµ„æº
        if (globalCleanup) {
          globalCleanup();
        }
      } else {
        console.log("Page visible, reinitializing GitHub stats if needed");
        // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åˆå§‹åŒ–
        setTimeout(() => {
          const shouldReinit = Array.from(container.querySelectorAll('[data-loading="true"]')).length > 0;
          if (shouldReinit) {
            const shouldUseImage = shouldUseImageFallback();
            const shouldUseFallback = shouldUseFallbackFromCookie();
            
            if (shouldUseImage || shouldUseFallback) {
              const username = getUsername();
              if (username) {
                startFallbackWatchers(username);
              }
            } else {
              initGitHubStats();
            }
          }
        }, 100);
      }
    });
    
    // ç›‘å¬beforeunloadäº‹ä»¶ - é¡µé¢å¸è½½å‰æ¸…ç†
    window.addEventListener("beforeunload", () => {
      console.log("Page unloading, cleaning up GitHub stats resources");
      if (globalCleanup) {
        globalCleanup();
      }
    });
    
    // ç›‘å¬pagehideäº‹ä»¶ - é¡µé¢éšè—æ—¶æ¸…ç†ï¼ˆæ›´å¯é çš„æ¸…ç†æ—¶æœºï¼‰
    window.addEventListener("pagehide", () => {
      console.log("Page hiding, cleaning up GitHub stats resources");
      if (globalCleanup) {
        globalCleanup();
      }
    });
    
    // Astroç‰¹æœ‰ï¼šç›‘å¬astro:page-loadäº‹ä»¶ï¼ˆé¡µé¢åŠ è½½å®Œæˆï¼‰
    document.addEventListener("astro:page-load", () => {
      console.log("Astro page loaded, checking GitHub stats initialization");
      setTimeout(() => {
        const container = document.querySelector(".github-stats-container");
        if (container) {
          // å¦‚æœå®¹å™¨å­˜åœ¨ä½†æ²¡æœ‰å†…å®¹ï¼Œé‡æ–°åˆå§‹åŒ–
          const hasContent = container.querySelector('#profile-stats, #github-calendar, #repo-list');
          if (!hasContent) {
            console.log("GitHub stats container found but empty, reinitializing");
            const shouldUseImage = shouldUseImageFallback();
            const shouldUseFallback = shouldUseFallbackFromCookie();
            
            if (shouldUseImage || shouldUseFallback) {
              const username = getUsername();
              if (username) {
                startFallbackWatchers(username);
              }
            } else {
              // æ­£å¸¸APIè°ƒç”¨æƒ…å†µï¼Œä¹Ÿéœ€è¦é‡æ–°åˆå§‹åŒ–
              console.log("Reinitializing GitHub stats with API calls");
              initGitHubStats();
            }
          } else {
            console.log("GitHub stats container already has content, skipping reinit");
          }
        }
      }, 200);
    });
    
    // Astroç‰¹æœ‰ï¼šç›‘å¬astro:before-preparationäº‹ä»¶ï¼ˆé¡µé¢åˆ‡æ¢å‰ï¼‰
    document.addEventListener("astro:before-preparation", () => {
      console.log("Astro before page preparation, cleaning up GitHub stats");
      if (globalCleanup) {
        globalCleanup();
      }
    });
  }

  // æ·»åŠ é‡è¯•åŠŸèƒ½
  function addRetryFunctionality() {
    const style = document.createElement("style");
    style.textContent = `
      .retry-button {
        margin-top: 8px;
        padding: 8px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: opacity 0.2s;
      }
      .retry-button:hover {
        opacity: 0.8;
      }
    `;
    document.head.appendChild(style);
  }

  // æ·»åŠ é‡è¯•æŒ‰é’®åˆ°é”™è¯¯ä¿¡æ¯ä¸­
  function addRetryButton(container: HTMLElement) {
    const button = document.createElement("button");
    button.className = "retry-button";
    button.textContent = t("retry");
    button.onclick = () => {
      initGitHubStats();
    };
    container.appendChild(button);
  }

  // è°ƒè¯•åŠŸèƒ½ï¼šæ·»åŠ æ¸…é™¤é™çº§æ¨¡å¼çš„æŒ‰é’®ï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒï¼‰
  if (
    window.location.hostname === "localhost" ||
    window.location.hostname === "127.0.0.1"
  ) {
    const debugStyle = document.createElement("style");
    debugStyle.textContent = `
      .debug-clear-fallback {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 9999;
        padding: 4px 8px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        opacity: 0.7;
      }
      .debug-clear-fallback:hover {
        opacity: 1;
      }
    `;
    document.head.appendChild(debugStyle);

    const debugButton = document.createElement("button");
    debugButton.className = "debug-clear-fallback";
    debugButton.textContent = "Clear Fallback";
    debugButton.onclick = () => {
      clearFallbackModeCookie();
      console.log("Debug: Cleared fallback cookie, reloading...");
      location.reload();
    };
    document.body.appendChild(debugButton);
  }

  // åº•éƒ¨çš„é‡å¤åˆå§‹åŒ–å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨ä¸Šæ–¹çš„åˆå§‹åŒ–é€»è¾‘
</script>
